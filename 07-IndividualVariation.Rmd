```{r setupindvar, include=FALSE}
rm(list = ls()) ; invisible(gc()) ; set.seed(42)
library(knitr)
library(tidyverse)
library(sf)
library(leaflet)
theme_set(bayesplot::theme_default())
opts_chunk$set(
  echo = F, message = F, warning = F, fig.height = 6, fig.width = 8,
  cache = T, cache.lazy = F)
crs <- '+proj=longlat +datum=WGS84' # leaflet CRS
```

# Individual variation

```{r inddata}
googlesheets4::read_sheet("https://docs.google.com/spreadsheets/d/1-INnZ563VkNBH8rnSwfWieuGwPo9x9GRSV6jXNzatmM/edit?usp=sharing",
                          "individuals") %>% 
  group_by(Genus, Species) %>% 
  summarise(N = n()) %>% 
  ggplot(aes(paste(Genus, Species), N, fill = (N > 9))) +
  geom_col() +
  coord_flip() +
  geom_hline(yintercept = 10, linetype = "dashed") +
  scale_fill_discrete(guide = "none") +
  theme(axis.title = element_blank())
inds <- googlesheets4::read_sheet("https://docs.google.com/spreadsheets/d/1-INnZ563VkNBH8rnSwfWieuGwPo9x9GRSV6jXNzatmM/edit?usp=sharing",
                          "individuals") %>% 
  rename(Individual = FieldCode) %>% 
  filter(StudyLevel == "individual")
ft <- googlesheets4::read_sheet("https://docs.google.com/spreadsheets/d/1-INnZ563VkNBH8rnSwfWieuGwPo9x9GRSV6jXNzatmM/edit?usp=sharing",
                          "ind_ft")
ft %>% 
  select(Individual) %>% 
  left_join(select(inds, Individual, DateField, TreeHeight, TreeDawkins, BranchHeight, BranchDawkins) %>% 
              unique()) %>% 
  write_tsv("~/Téléchargements/indFTcov.tsv")
paracou <- bind_rows(
  src_sqlite(file.path("/home/sylvain//Documents/BIOGECO/PhD/data/Paracou/",
                       "trees", "Paracou.sqlite")) %>% 
    tbl("Paracou") %>% 
    filter(CodeAlive == 1) %>% 
    filter(Plot == 6) %>%
    filter(CensusYear == 2017) %>% 
    collect() %>% 
    mutate(DBH = CircCorr/pi) %>% 
    select(Plot, SubPlot, TreeFieldNum, idTree, Xutm, Yutm, DBH),
  read_csv2("data/Paracou_P16_2020.csv") %>% 
    mutate(DBH = CircCorr/pi) %>% 
    select(Plot, SubPlot, TreeFieldNum, idTree, Xutm, Yutm, DBH)
)


inds <- inds %>% 
  left_join(paracou) %>% 
  select(Individual, Xutm, Yutm, DBH)

indsXY <- inds %>% 
  st_as_sf(coords = c("Xutm", "Yutm"),
           crs = '+proj=utm +zone=22 +datum=WGS84 +units=m +no_defs +ellps=WGS84 +towgs84=0,0,0')
inds$TWI <- raster::extract(raster::raster("data/TWI_1m.tif"), indsXY)
write_tsv(inds, "~/Téléchargements/indFTvar.tsv")
```

