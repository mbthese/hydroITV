```{r setupmeaserr, include=FALSE}
rm(list = ls()) ; invisible(gc()) ; set.seed(42)
library(knitr)
library(tidyverse)
library(dplyr)
theme_set(bayesplot::theme_default())
opts_chunk$set(
  echo = F, message = F, warning = F, fig.height = 6, fig.width = 8,
  cache = T, cache.lazy = F)
varcols <- c(species = "red", individual = "lightgreen", 
             sample = "lightblue", repetition = "orange", residual = "grey")
```

# Measurement error

$\Psi_{TLP}$, $\frac{Fv}{Fm}$, and $LT$ were directly measured. 
$RWC$ was calculated as the fresh weight, i.e. empty bag weight minus fresh leave in bag weight, minus the dry weight divided by the saturated weight minus the dry weight.
$LA$ was determined from scan using `ImageJ` and `R` scripts at the end before converting pixels square to centimeters square.
$LDMC$ was calculated as the dry weight divided by the fresh weight.
$SLA$ was calculated as the leaf area divided by the dry weight. 
$CC$ was not measured yet.

```{r measdata}
ptlp <- googlesheets4::read_sheet("https://docs.google.com/spreadsheets/d/19eULgGa02RS6hwn2ngeEu4akF2YdaQGHS5xSac2hIYI/edit?usp=sharing",
                                  "measure_ptlp") %>% 
  mutate(C0 = as.numeric(C0))
fvfm <- googlesheets4::read_sheet("https://docs.google.com/spreadsheets/d/19eULgGa02RS6hwn2ngeEu4akF2YdaQGHS5xSac2hIYI/edit?usp=sharing",
                            "measure_fvfm") %>% 
    mutate(FvFm = as.numeric(FvFm)) 
rwc <- googlesheets4::read_sheet("https://docs.google.com/spreadsheets/d/19eULgGa02RS6hwn2ngeEu4akF2YdaQGHS5xSac2hIYI/edit?usp=sharing",
                            "measure_rwc") %>% 
    mutate(RWC = ((as.numeric(BagFreshWeight) - as.numeric(BagWeight))-DryWeight)/(SaturatedWeight-DryWeight))
soft <- googlesheets4::read_sheet("https://docs.google.com/spreadsheets/d/19eULgGa02RS6hwn2ngeEu4akF2YdaQGHS5xSac2hIYI/edit?usp=sharing",
                                  "measure_soft") %>% 
  mutate(LA = LApixel / ((300 ^2 ) * (2.54^2)), LDMC = DryWeight/FreshWeight, LT = LTmean) %>% 
  mutate(SLA = LA/DryWeight)
traits <- bind_rows(
  soft %>% 
    mutate(Date = lubridate::date(Date)) %>% 
    select(Date, Sample, Repetition, Leaf, LA, LDMC, LT, SLA) %>%
    reshape2::melt(c("Date", "Sample", "Repetition", "Leaf"), variable.name = "trait"),
  ptlp %>% 
    mutate(Date = lubridate::date(Date_measure)) %>% 
    mutate(Sample  = Nr_Leaf, Repetition = Nr_Cycle, Leaf = 1) %>% 
    select(Date, Sample, Repetition, Leaf, Ptlp) %>% 
    mutate(trait = "Ptlp") %>% 
    rename(value = Ptlp) %>% 
    na.omit(),
  fvfm %>% 
    mutate(Date = lubridate::date(Date)) %>% 
    mutate(Sample  = Leaf, Leaf = 1) %>% 
    select(Date, Sample, Repetition, Leaf, FvFm) %>% 
    mutate(trait = "FvFm") %>% 
    rename(value = FvFm) %>% 
    na.omit(),
  rwc %>% 
    mutate(Date = lubridate::date(Day)) %>% 
    mutate(Leaf = 1) %>% 
    select(Date, Sample, Repetition, Leaf, RWC) %>% 
    mutate(trait = "RWC") %>% 
    rename(value = RWC) %>% 
    na.omit()
)

# traits %>% 
#   group_by(trait, Sample, Repetition) %>% 
#   summarise(value = mean(value)) %>% 
#   reshape2::dcast(Sample + Repetition ~ trait, value.var = "value") %>% 
#   write_tsv( "~/Téléchargements/MeasFT.tsv")

# autoplot(princomp(~ LA + LDMC + LT + SLA + Ptlp + FvFm + RWC, reshape2::dcast(traits, Sample + Repetition + Leaf ~ trait), scale = T),
#          loadings = T, loadings.label = T)
```


```{r measureBoxplots, fig.cap="Traits distributions when testing for measurement error."}
traits %>% 
  group_by(Date, Sample, Repetition, trait) %>% 
  summarise(value = mean(value, na.rm = T)) %>% 
  mutate(trait = recode(trait, "Ptlp" = "Psi[TLP]", "FvFm" = "frac(Fv,Fm)")) %>% 
  ggplot(aes(as.factor(Sample), value)) +
  geom_boxplot(aes(fill = as.character(Date)),
               alpha = 0.5, col = "lightgrey") +
  geom_point(aes(col = Repetition)) +
  viridis::scale_color_viridis("Repetition") +
  scale_fill_discrete("Day") +
  facet_wrap(~ trait, scales = "free", labeller = label_parsed, nrow = 2) +
  xlab("Sample") + 
  theme(axis.title = element_blank(), legend.position = "bottom")
```

```{r measureVars, fig.cap="Traits variances when testing for measurement error."}
traits %>% 
  group_by(Date, Sample, Repetition, trait) %>% 
  summarise(value = mean(value, na.rm = T)) %>% 
  group_by(trait, Sample) %>% 
  sample_n(5) %>% 
  group_by(trait) %>% 
  do(var = nlme::lme(value ~ 1, random=~1|Sample/Repetition, data = .) %>% 
       ape::varcomp(scale = F, cum = F) %>% 
       as.vector() %>% 
       data.frame(level = c("Sample", "Repetition", "Residual"), variance = as.vector(.))) %>% 
  unnest(var) %>% 
  select(-`.`) %>% 
  group_by(trait) %>% 
  mutate(pct = variance / sum(variance)*100) %>% 
  mutate(trait = recode(trait, "Ptlp" = "Psi[TLP]", "FvFm" = "frac(Fv,Fm)")) %>% 
  mutate(level = factor(level, levels = c("Sample", "Repetition", "Residual"))) %>% 
  ggplot(aes(x = trait, y = pct, fill = level)) +
  geom_bar(stat = "identity", position = "stack") +
  scale_fill_manual(expression(sigma), 
                    values = unname(varcols[c("sample", "repetition", "residual")])) +
  xlab("Trait") + ylab("Percentage of variance") +
  scale_x_discrete(labels = scales::parse_format())
```

```{bash imageJsoft, eval=F, echo=T}
run("Image Sequence...", "open=/home/sylvain/Documents/ECOFOG/hydroITV/data/traits/measure/measure_20210818_soft_scans/Soft_C0_S1_R5.jpg sort");
run("8-bit");
setAutoThreshold("Default");
//run("Threshold...");
setAutoThreshold("Default");
setOption("BlackBackground", false);
run("Convert to Mask", "method=Default background=Light calculate");
run("Close");
run("Analyze Particles...", "size=10000-Infinity show=[Overlay Masks] display exclude clear in_situ stack");
saveAs("Results", "/home/sylvain/Documents/ECOFOG/hydroITV/data/traits/measure/measure_20210820_LA_ss.tsv");
```

```{r imagejRsoft, eval=F, echo=T}
read_tsv("data/traits/measure/measure_20210820_LA_ss.tsv") %>% 
  separate(Label, paste0("X", 1:8)) %>% 
  rename(Plot = X6, Sample = X7, Repetition = X8) %>% 
  select(Plot, Sample, Repetition, Area) %>% 
  group_by(Sample, Repetition) %>% 
  mutate(Leaf = paste0("L", 1:n())) %>% 
  mutate(Leaf = ifelse(Sample == "S1" & Repetition %in% c("R4", "R5"), c("L1", "L2", "L2", "L2", "L2", "L3"), Leaf)) %>% 
  group_by(Plot, Sample, Repetition, Leaf) %>% 
  summarise(Area = sum(Area)) %>% 
  write_tsv("data/traits/measure/measure_20210820_LAcor_ss.tsv")
```
