```{r setupvirtualdata, include=FALSE}
rm(list = ls()) ; invisible(gc()) ; set.seed(42)
library(knitr)
library(kableExtra)
if(knitr:::is_html_output()) options(knitr.table.format = "html") 
if(knitr:::is_latex_output()) options(knitr.table.format = "latex") 
library(tidyverse)
library(ggfortify)
theme_set(bayesplot::theme_default())
knitr::opts_chunk$set(
	echo = F,
	fig.height = 6,
	fig.width = 8,
	message = FALSE,
	warning = FALSE,
	cache = TRUE,
	cache.lazy = F
)
varcols <- c(species = "red", tree = "lightgreen", 
             sample = "lightblue", measure = "orange")
```

# (PART) Material {-}

# Virtual data

This chapter demonstrates the importance of a balanced design in the distribution of variance, in contrast to the many papers reporting inter- and intraspecific variation in unbalanced designs. It also virtually explores the evaluation of leaf and measurement variation.

## Simulation

We simulated thus $T=8$ trait 
for $S=100$ species with an among-species trait variance $\sigma_{S}=1$
including each $S=100$ individuals per species with an within-species trait variance $\sigma_{I}=1$.

```{r virtualdata}
S <- 100
I <- 100
sigma_s <- 1
sigma_i <- 1
ft <- data.frame(species = 1:S, trait = rnorm(S, 10, sigma_s)) %>% 
  rowwise() %>% 
  mutate(trait = list(data.frame(individual = 1:I, trait = rnorm(I, trait, sigma_i)))) %>% 
  unnest(trait) %>% 
  mutate_at(c("species", "individual"), as.factor)
```

```{r virtualdata2}
S <- 100
I <- 100
Tr <- 8
sigma_s <- 1
sigma_i <- 1
# Cov <- matrix(runif(Tr^2)*2-1, ncol=Tr) ; Cov <- t(Cov) %*% Cov # method 1
# Cov <- rWishart(1, Tr, diag(Tr))[,,1] # method 2
# Cov <- clusterGeneration::genPositiveDefMat(Tr)$Sigma # method 3
Cov <- clusterGeneration::rcorrmatrix(Tr) # method 4
ft2 <- as.data.frame(mvtnorm::rmvnorm(S, mean = rnorm(Tr, 10), sigma=Cov*10)) %>% 
  rename_all(funs(gsub("V", "T", .))) %>% 
  mutate(species = 1:S) %>% 
  rowwise() %>% 
  mutate(traits = list(
    as.data.frame(mvtnorm::rmvnorm(I, mean = c(T1, T2, T3, T4, T5, T6, T7, T8), sigma=Cov)) %>% 
      rename_all(funs(gsub("V", "T", .))) %>% 
      mutate(individual = 1:I)
  )
  ) %>% 
  dplyr::select(species, traits) %>% 
  unnest(traits)
```

```{r virtualdatafig, fig.cap="Trait distribution in the virtual community."}
ggplot(ft, aes(trait, group = species)) +
  geom_density(fill = "grey", alpha = 0.5)
```


```{r corvirtualdata2, fig.cap="Correlations among simulated traits."}
ft2 %>% 
  dplyr::select(-species, -individual) %>% 
  cor() %>% 
  corrplot::corrplot.mixed()
```

## Species and individual sampling

```{r virtualsamplingfunction}
sampling <- function(data, species, individuals){
  Nsp <- species
  data %>% 
    filter(species %in% sample(1:max(as.numeric(data$species)), Nsp)) %>% 
    group_by(species) %>% 
    sample_n(individuals) %>% 
    ungroup()
}
```

We tested the effect of 3 sampling strategies on variance partitioning (Fig. \@ref(fig:traitdist)):

1. sampling of 100 individuals unbalanced in species (25 species with 4 individuals)
1. sampling of 100 individuals unbalanced in individuals (4 species with 25 individuals)
1. sampling of 100 individuals unbalanced in species and individual (10 species with 10 individuals)

```{r virtualtraitdist, fig.cap="Trait distribution per species with balanced and unbalanced sampling design."}
R <- 2
lapply(as.list(1:R), function(r)
  list("unbalanced species" = sampling(ft, 25, 4), 
       "unbalanced individuals" = sampling(ft, 4, 25), 
       "balanced"  = sampling(ft, 10, 10)) %>% 
    bind_rows(.id = "sampling") %>% 
    mutate(repetition = paste("repetition", r))) %>% 
  bind_rows() %>% 
  mutate(sampling = factor(sampling, levels = c("full", "unbalanced species",
                                                "unbalanced individuals", "balanced"))) %>% 
  ggplot(aes(trait, group = as.factor(species))) +
  geom_density(alpha = 0.3) +
  facet_grid(repetition ~ sampling, scales = "free")
```

## Trait variation

### Coefficients of variation (CV)

```{r cvfunction}
cv <- function(traits){
  if(any(is.na(traits)))
    traits=traits[!is.na(traits)]
  N=length(traits)
  y_bar=mean(traits)
  s2_hat=var(traits)
  cv_2=s2_hat/y_bar^2
  cv_1=sqrt(cv_2)
  gamma_1=sum(((traits-y_bar)/s2_hat^0.5)^3)/N
  gamma_2=sum(((traits-y_bar)/s2_hat^0.5)^4)/N
  bias=cv_2^(3/2)/N*(3*cv_2^0.5-2*gamma_1)
  bias2=cv_1^3/N-cv_1/4/N-cv_1^2*gamma_1/2/N-cv_1*gamma_2/8/N
  cv1=sd(traits)/mean(traits)
  cv4=cv_1-bias2
  re=cv4
  return(re)
} 
```

```{r cv, fig.cap="Effect of the sampling strategy on the coefficient of variation.  Coefficients of variation were obtained for every sampling strategy: 4 individuals in 25 species (unbalanced species), 25 individuals in 4 species (unbalanced individuals), and 10 individuals in 10 species (balanced). Dashed line represents the expected variance partitioning based on the full community of 100 individuals in 100 species."}
options(dplyr.summarise.inform = FALSE)
R <- 100
cv_sampling <- lapply(as.list(1:R), function(r)
  list("unbalanced species" = sampling(ft, 25, 4),
       "unbalanced individuals" = sampling(ft, 4, 25),
       "balanced"  = sampling(ft, 10, 10)) %>%
    bind_rows(.id = "sampling") %>%
    group_by(sampling, species) %>%
    summarise(cv = cv(trait)) %>%
    group_by(sampling) %>%
    summarise(cv = median(cv)) %>%
    mutate(repetition = r)) %>%
  bind_rows()
cv_full <- ft %>%
  group_by(species) %>%
  summarise(cv = cv(trait)) %>%
  ungroup() %>%
  summarise(cv = mean(cv))
ggplot(cv_sampling, aes(sampling, cv)) +
  geom_boxplot() +
  geom_hline(aes(yintercept = cv), linetype = "dashed",
             data = cv_full) +
  ylab(expression(CV[4])) + xlab("Sampling strategy")
```

### Variance partitionning (LMM)

```{r varpartfunction}
varpart <- function(data){
  var <- ape::varcomp(nlme::lme(trait ~ 1, random=~1|species, data), 1)
  return(
    data.frame(level = names(var), variance = as.vector(var)) %>% 
      mutate(level = recode(level, "Within" = "tree"))
  )
}
```

```{r varpart, fig.cap="Effect of the sampling strategy on variance partitioning. Variance partitioning was obtained using linear mixed models for every sampling strategy: 4 individuals in 25 species (unbalanced species), 25 individuals in 4 species (unbalanced individuals), and 10 individuals in 10 species (balanced). Dashed line represents the expected variance partitioning based on the full community of 100 individuals in 100 species."}
R <- 100
vp <- lapply(as.list(1:R), function(r)
  list("unbalanced species" = sampling(ft, 25, 4),
       "unbalanced individuals" = sampling(ft, 4, 25),
       "balanced"  = sampling(ft, 10, 10)) %>%
    bind_rows(.id = "sampling") %>%
    group_by(sampling) %>%
    do(var = varpart(.)) %>%
    unnest(var) %>%
    mutate(repetition = r)) %>%
  bind_rows() %>%
  mutate(level = factor(level, levels = c("species", "tree")))
vp_med <- vp %>%
  group_by(sampling, level) %>%
  summarise(variance = median(variance))
ggplot(filter(vp, level == "tree"),
       aes(x = sampling, y = variance)) +
  geom_bar(aes(fill = level), stat = "identity", position = "stack", data = vp_med) +
  geom_boxplot(alpha = 0.6, width = 0.3) +
  geom_hline(aes(yintercept = 0.5), linetype = "dashed") +
  scale_fill_manual(expression(sigma^2),
                    values = unname(varcols[c("species", "tree")])) +
  ylab("Percentage of variance") + xlab("Sampling strategy")
```

## Trait co-variation

## Among-species correlations

```{r spcorvirtual}
R <- 100
all_cor <- ft2 %>% 
  dplyr::select(-species, - individual) %>% 
  cor() %>% 
  as.data.frame() %>% 
  rownames_to_column("Trait") %>% 
  filter(Trait == "T1") %>% 
  dplyr::select(-T1, -Trait) %>% 
  reshape2::melt(variable.name = "Trait", value.name = "cor")
cors <- lapply(as.list(1:R), function(r)
  lapply(
    list("unbalanced species" = sampling(ft2, 25, 4),
         "unbalanced individuals" = sampling(ft2, 4, 25),
         "balanced"  = sampling(ft2, 10, 10)),
    function(d)
      dplyr::select(d,-species, - individual) %>% 
      cor() %>% 
      as.data.frame() %>% 
      rownames_to_column("Trait") %>% 
      filter(Trait == "T1") %>% 
      dplyr::select(-T1, -Trait)
  ) %>% bind_rows(.id = "sampling") %>%
    mutate(repetition = r)) %>% 
  bind_rows() %>% 
  reshape2::melt(c("sampling", "repetition"), variable.name = "Trait", value.name = "cor")
ggplot(cors, aes(sampling, cor)) +
  geom_boxplot(col = "grey") +
  facet_wrap(~ Trait, scales = "free_x") +
  geom_hline(aes(yintercept = cor), all_cor, linetype = "dashed") +
  coord_flip() +
  xlab("") + ylab("Correlations")
```

### Within-species correlations

```{r indcorvirtual}
R <- 100
all_cor <- ft2 %>% 
  reshape2::melt(c("species", "individual"), variable.name = "trait") %>% 
  group_by(species, trait) %>% 
  mutate(value = value - mean(value)) %>% 
  reshape2::dcast(species + individual ~ trait) %>% 
  dplyr::select(-species, - individual) %>% 
  cor() %>% 
  as.data.frame() %>% 
  rownames_to_column("Trait") %>% 
  filter(Trait == "T1") %>% 
  dplyr::select(-T1, -Trait) %>% 
  reshape2::melt(variable.name = "Trait", value.name = "cor")
cors <- lapply(as.list(1:R), function(r)
  lapply(
    list("unbalanced species" = sampling(ft2, 25, 4),
         "unbalanced individuals" = sampling(ft2, 4, 25),
         "balanced"  = sampling(ft2, 10, 10)),
    function(d)
      reshape2::melt(d, c("species", "individual"), variable.name = "trait") %>% 
      group_by(species, trait) %>% 
      mutate(value = value - mean(value)) %>% 
      reshape2::dcast(species + individual ~ trait) %>% 
      dplyr::select(-species, - individual) %>% 
      cor() %>% 
      as.data.frame() %>% 
      rownames_to_column("Trait") %>% 
      filter(Trait == "T1") %>% 
      dplyr::select(-T1, -Trait)
  ) %>% bind_rows(.id = "sampling") %>%
    mutate(repetition = r)) %>% 
  bind_rows() %>% 
  reshape2::melt(c("sampling", "repetition"), variable.name = "Trait", value.name = "cor")
ggplot(cors, aes(sampling, cor)) +
  geom_boxplot(col = "grey") +
  facet_wrap(~ Trait, scales = "free_x") +
  geom_hline(aes(yintercept = cor), all_cor, linetype = "dashed") +
  coord_flip() +
  xlab("") + ylab("Within-species correlations")
```

```{r pcavirtual1, eval=F}
R <- 100
all_pca <- prcomp(~ T1 + T2 + T3 + T4 + T5 + T6 + T7 + T8, data = ft2, center = T, scale = T) %>%
  .$rotation %>%
  as.data.frame() %>%
  rownames_to_column("Trait")
pcas <- lapply(as.list(1:R), function(r)
  lapply(
    list("unbalanced species" = sampling(ft2, 25, 4),
         "unbalanced individuals" = sampling(ft2, 4, 25),
         "balanced"  = sampling(ft2, 10, 10)),
    function(d)
      prcomp(~ T1 + T2 + T3 + T4 + T5 + T6 + T7 + T8, data = d, center = T, scale = T) %>% 
      .$rotation %>% 
      as.data.frame() %>% 
      rownames_to_column("Trait") 
  ) %>% bind_rows(.id = "sampling") %>%
    mutate(repetition = r)) %>% 
  bind_rows()
cowplot::plot_grid(
  pcas %>% 
    filter(Trait == "T1") %>% 
    ggplot(aes(x = abs(PC1), y = abs(PC2), col = sampling)) +
    geom_segment(aes(x = 0, y = 0, xend = PC1, yend = PC2), data = all_pca,
                 arrow = arrow(length = unit(1/2, "picas")), color = c("black", rep("grey", 7))) +
    geom_point(alpha  = 0.5) +
    ggrepel::geom_text_repel(aes(x = PC1, y = PC2, label = Trait), data = all_pca, color = c("black", rep("grey", 7))) +
    xlab("PC1") + ylab("PC2"),
  pcas %>% 
    filter(Trait == "T1") %>% 
    select(sampling, PC1, PC2) %>% 
    reshape2::melt("sampling") %>% 
    ggplot(aes(sampling, abs(value))) +
    geom_boxplot() +
    geom_hline(aes(yintercept = value), linetype = "dashed",
               filter(all_pca, Trait == "T1") %>% 
                 select(PC1, PC2) %>% 
                 reshape2::melt()) +
    facet_wrap(~ variable) +
    ylab("PC value") + xlab(""),
  nrow = 2
)
```

```{r pcavirtual2, eval=F}
R <- 100
all_pca <- prcomp(~ T1 + T2 + T3 + T4 + T5 + T6 + T7 + T8, data = ft2, center = T, scale = T) %>%
  .$rotation %>%
  as.data.frame() %>%
  rownames_to_column("Trait") %>% 
  reshape2::melt("Trait", variable.name = "PC") %>% 
  reshape2::dcast(PC ~ Trait) %>% 
  dplyr::select(-PC) %>% 
  cor() %>% 
  as.data.frame() %>% 
  rownames_to_column("Trait") %>% 
  filter(Trait == "T1") %>% 
  dplyr::select(-T1, -Trait) %>% 
  reshape2::melt(variable.name = "Trait", value.name = "cor")
pcas <- lapply(as.list(1:R), function(r)
  lapply(
    list("unbalanced species" = sampling(ft2, 25, 4),
         "unbalanced individuals" = sampling(ft2, 4, 25),
         "balanced"  = sampling(ft2, 10, 10)),
    function(d)
      prcomp(~ T1 + T2 + T3 + T4 + T5 + T6 + T7 + T8, data = d, center = T, scale = T) %>% 
      .$rotation %>% 
      as.data.frame() %>% 
      rownames_to_column("Trait") %>% 
  reshape2::melt("Trait", variable.name = "PC") %>% 
  reshape2::dcast(PC ~ Trait) %>% 
  dplyr::select(-PC) %>% 
  cor() %>% 
  as.data.frame() %>% 
  rownames_to_column("Trait") %>% 
  filter(Trait == "T1") %>% 
    dplyr::select(-T1, -Trait)
  ) %>% bind_rows(.id = "sampling") %>%
    mutate(repetition = r)) %>% 
  bind_rows() %>% 
  reshape2::melt(c("sampling", "repetition"), variable.name = "Trait", value.name = "cor")
ggplot(pcas, aes(sampling, abs(cor))) +
  geom_boxplot(col = "grey") +
  facet_wrap(~ Trait) +
  geom_hline(aes(yintercept = abs(cor)), all_pca, linetype = "dashed") +
  coord_flip() +
  xlab("") + ylab("Correlation in PCA") +
  scale_y_sqrt()
```



