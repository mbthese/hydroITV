```{r setupcv, include=FALSE}
rm(list = ls()) ; invisible(gc()) ; set.seed(42)
library(knitr)
library(tidyverse)
library(CV)
# install_github("guochunshen/cv")
theme_set(bayesplot::theme_default())
opts_chunk$set(
  echo = F, message = F, warning = F, fig.height = 6, fig.width = 8,
  cache = T, cache.lazy = F)
cv <- function(traits){

  if(any(is.na(traits))){
    warning("Missing values detected in samples and will be removed in the analysis.")
    traits=traits[!is.na(traits)]
  }

  N=length(traits)


  #calcualte CV^2
  y_bar=mean(traits)
  s2_hat=var(traits)
  cv_2=s2_hat/y_bar^2
  cv_1=sqrt(cv_2)
  gamma_1=sum(((traits-y_bar)/s2_hat^0.5)^3)/N
  gamma_2=sum(((traits-y_bar)/s2_hat^0.5)^4)/N
  bias=cv_2^(3/2)/N*(3*cv_2^0.5-2*gamma_1)
  bias2=cv_1^3/N-cv_1/4/N-cv_1^2*gamma_1/2/N-cv_1*gamma_2/8/N
  cv1=sd(traits)/mean(traits)
  cv4=cv_1-bias2
  re=cv4
  return(re)
}
```

```{r cvdata}
Data <- googlesheets4::read_sheet("https://docs.google.com/spreadsheets/d/19eULgGa02RS6hwn2ngeEu4akF2YdaQGHS5xSac2hIYI/edit#gid=0", range = "traits")
Data_Indv <- filter(Data, Data$StudyLevel == "tree")
Data_Indv <- Data_Indv %>%
  unite("name", Genus:Species)
```

# Traits variation: coefficient of variation

Coefficient of variation (CV) is defined as the standard deviation divided by the mean and expressed as a percentage. 
It is the most commonly used estimator of ITV. <!-- Really? -->
It does not require any *ad hoc* assumptions. 
It is unitless and therefore convenient to compare variation of traits among species.

According to Yang 2020, <!-- to change with true reference -->
the best ITV estimator is CV1 when N >100.

$$CV1=\frac{sd(traits)}{mean(traits)}$$

For non-normal distribution of raw data or even after a logarithm transformation, CV4, or Bao's estimator, is preferred:

$$CV4=CV1-(\frac{CV1^3}{N}-CV1/4/N-CV1^2*\gamma_1/2/N-CV1*\gamma_2/8/N)$$ 
<!-- Could you clarify the formula? -->
  
Where gamma is Pearson's measure of skewness and kurtosis of the trait sample distribution.

Log-transformation places less weight on the extreme large values resulting in a more robust estimation of ITV. 
It also reduced the skewness of the data, which makes it easier to handle. 

We will calculate CV4 using the [`CV` package](from https://www.github.com/guochunshen/CV).

## CV per species

For each trait, we described the magnitude of intraspecific variation by calculating coefficients of variation (CV) across each species. 

The log-transformation reduces the proportional bias of ITV (Yang, 2020). <!-- to change with true reference --> 
CV only makes sense only on positive data, so we take the abs(Ptlp).

*Beware: CV was sometimes calculated for n<10 samples for some trait per species!*

```{r cvsptab}
CV<- aggregate(cbind(log(LA), log(SLA), log(LT), log(CC), log(LDMC), log(FvFm)) ~ name, 
          data = Data_Indv,
          FUN = cv)
CV <- rename(CV, LA =V1, SLA = V2, LT = V3, CC = V4, LDMC= V5, FvFm = V6)

CV_cont <-aggregate(cbind(log(LSWC), log(abs(Ptlp)), gmin) ~ name, 
          data = Data_Indv,
          FUN = cv)
CV_cont <- rename(CV_cont, LSWC = V1, Ptlp = V2)


CV_tot <- left_join(CV, CV_cont, by= "name")

CV_tot %>% 
  rename(Species = name) %>% 
  mutate(Species = gsub("_", "\n", Species)) %>% 
  knitr::kable(caption = "Caption", digits = 3)
```

```{r cvspfig, fig.cap="Caption.", fig.height=10, fig.width=10}
CV_tot %>% 
  rename(Species = name) %>% 
  mutate(Species = gsub("_", " ", Species)) %>% 
  reshape2::melt("Species", variable.name = "trait", value.name = "CV") %>% 
  mutate(trait = recode(trait, "Ptlp" = "-pi[TLP]", "FvFm" = "frac(Fv,Fm)", "gmin" = "g[min]")) %>% 
  ggplot(aes(x = Species, y = CV, fill = Species, col = Species)) +
  geom_boxplot(shape = "circle") +
  facet_wrap(~ trait, scales = "free", labeller = label_parsed) +
  theme(axis.title.x = element_blank(), axis.text.x = element_blank())
```

## Global CV

```{r cvglobaltab}
LA<- cv(log(Data_Indv$LA))
SLA<- cv(log(Data_Indv$SLA))
LT <-cv(log(Data_Indv$LT))
CC <- cv(log(Data_Indv$CC))
LDMC <- cv(log(Data_Indv$LDMC))
FvFm<- cv(log(Data_Indv$FvFm))
RWC <- cv(log(Data_Indv$RWC))
LSWC <- cv(log(Data_Indv$LSWC))
abs_Ptlp <- cv(log(abs(Data_Indv$Ptlp))) #cv only makes sense only on positive data
gmin <- cv(log(Data_Indv$gmin))

logsT <- rbind(LA, SLA, LT, CC, LDMC, FvFm, RWC, LSWC, abs_Ptlp, gmin)


logsT <- round(logsT, digits = 2)

as.data.frame(logsT) %>% 
  rownames_to_column("trait") %>% 
  rename(CV = V1) %>% 
  mutate(trait = recode(trait, 
                        SLA = "$SLA$",
                        LDMC = "$LDMC$", 
                        LT = "$LT$", 
                        LA = "$LA$",
                        CC = "$CC$",
                        gmin = "$g_{min}$",
                        abs_Ptlp = "$-\\pi_{TLP}$",
                        RWC = "$RWC$",
                        FvFm = "$\\frac{Fv}{Fm}$",
                        LSWC = "$LSWC$")) %>% 
knitr::kable(caption = "Caption")
```

```{r cvglobalfig, fig.cap="Caption."}
as.data.frame(logsT) %>% 
  rownames_to_column("Trait") %>% 
  rename(CV = V1) %>% 
  mutate(Trait = recode(Trait, "abs_Ptlp" = "-pi[TLP]", "FvFm" = "frac(Fv,Fm)", "gmin" = "g[min]")) %>% 
  ggplot(aes(x = Trait, y = CV)) +
  geom_boxplot(shape = "circle") + 
  scale_x_discrete(labels = scales::parse_format())
```

## Results 

*(looking at CV4)*

All traits exhibited considerable intraspecific variation, with CVs ranging from approximately 16–85% (\@ref(tab:cvsptab)).
LSWC and $-\pi_{TLP}$, exhibited low variation at 22 % and 16%. 
LT, CC and LDMC had intermediate variation, both 30 % for LT and CC and 41 % for LDMC.
All other traits (LA, SLA, $\frac{Fv}{Fm}$ and $g_{min}$) varied with CVs ≥ 70%. 

SLA exhibited the highest intraspecific variation (CV = 85%), 
with SLA values ranging from 11.01008 to 949.3594 $m^2.kg^{-1}$.

(?) RWC exhibited the lowest intraspecific variation (CV = 0.06%).

## Discussion

CV allows us to compare the distribution of trait values when those are expressed in different units. 
The higher the CV is, the higher the dispersion of the individual values around the mean. 
CV offers a way to directly compare variation among species with different abundances (Helsen et al., 2017).  <!-- to change with true reference --> 
Studies have shown a positive relationship between species ITV and niche breadth (Clark, 2010):  <!-- to change with true reference --> 
species with larger ITV tend to have larger geographical ranges than species with smaller ITV (Brown, 1984).  <!-- to change with true reference --> 
